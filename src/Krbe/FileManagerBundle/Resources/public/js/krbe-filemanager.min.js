Dropzone.autoDiscover=!1,document.addEventListener("DOMContentLoaded",function(){function n(n){var e=krbeFilemanagerUrlWidgetListfiles+"/"+encodeURI(n||"");fetch(e,{headers:{"X-Requested-With":"XMLHttpRequest"}}).then(e=>e.text()).then(e=>{var t=document.getElementById("files-list");t.setAttribute("krbe-filemanager-currentfolder",n),t.innerHTML=e,r(n)}).catch(e=>console.error("Erreur de chargement de la liste de fichiers :",e))}function r(e){document.querySelectorAll("[data-krbe-filemanager] li.current").forEach(function(e){e.classList.remove("current")});var t=document.querySelector('[data-krbe-filemanager] a[data-krbe-filemanager-folder="'+e+'"]'),t=(t&&(t=t.closest("li"))&&t.classList.add("current"),document.querySelector('form#hidden-upload-form input[name="subFolder"]'));t&&(t.value=e||"")}r(subFolder),document.body.addEventListener("click",function(e){console.log("Click body détecté, cible :",e.target);var t=e.target.closest("a[data-krbe-filemanager-folder]");t&&(e.preventDefault(),n(t.getAttribute("data-krbe-filemanager-folder")))});let l=new Dropzone("#hidden-upload-form",{autoProcessQueue:!0,paramName:"file",maxFilesize:10,init:function(){this.on("success",function(e,t){console.log("Fichier téléversé:",t.filePath),n(document.getElementById("files-list").getAttribute("krbe-filemanager-currentfolder"))}),this.on("error",function(e,t){let n=translations.error_during_upload;t&&"object"==typeof t&&t.error?n=t.error:"string"==typeof t&&(n=t),alert(n)})}});var e=document.getElementById("folder-content");let a=document.getElementById("dropzone-overlay"),o=0;e.addEventListener("dragenter",function(e){e.preventDefault(),o++,a.style.display="flex"}),e.addEventListener("dragleave",function(e){e.preventDefault(),--o<=0&&(a.style.display="none",o=0)}),e.addEventListener("dragover",function(e){e.preventDefault()}),e.addEventListener("drop",function(e){e.preventDefault(),a.style.display="none",o=0;var t=e.dataTransfer.files;if(0<t.length)for(let e=0;e<t.length;e++)l.addFile(t[e])});e=document.getElementById("search"),e?(console.log("Search field trouvé"),e.addEventListener("keyup",function(){console.log("Recherche déclenchée, valeur :",this.value);let n=this.value.toLowerCase();document.querySelectorAll(".file-item, .folder-item").forEach(function(e){var t=e.querySelector("p");t?(t=t.textContent.toLowerCase(),e.style.display=t.includes(n)?"":"none"):console.warn("L'élément n'a pas de <p> :",e)})})):console.error("Champ de recherche introuvable"),e=document.getElementById("toggle-view");e?(console.log("Bouton toggle view trouvé"),e.addEventListener("click",function(){var e=document.getElementById("files-list");e&&(console.log("Toggle view sur files-list"),e.classList.toggle("list-view"))})):console.error("Bouton toggle view introuvable"),document.getElementById("import-btn").addEventListener("click",function(){l.hiddenFileInput.click()}),document.getElementById("create-folder-btn").addEventListener("click",function(){var e,t=prompt(translations.new_folder_name);t&&""!==t.trim()?(e=document.getElementById("files-list").getAttribute("krbe-filemanager-currentfolder")||"",fetch(krbeFilemanagerUrlFctCreateFolder,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({folderName:t.trim(),currentFolder:e})}).then(e=>e.json()).then(e=>{var t;e.folderPath?(alert(translations.folder_created),n(e.folderPath),t=e.folderPath.slice(1),fetch(krbeFilemanagerUrlWidgetListfolders,{headers:{"X-Requested-With":"XMLHttpRequest"}}).then(e=>e.text()).then(e=>{document.getElementById("directory-nav-tree").innerHTML=e,r(t)}).catch(e=>console.error("Erreur de chargement de l'arborescence :",e))):alert(translations.folder_create_error+(e.error||""))}).catch(e=>{console.error("Erreur lors de la création du dossier :",e),alert(translations.folder_create_error_generic)})):alert(translations.invalid_folder_name)});let i,s=document.getElementById("crop-modal"),c=document.getElementById("crop-image"),d=document.getElementById("crop-width"),u=document.getElementById("crop-height"),m=(document.getElementById("apply-dimensions").addEventListener("click",function(){var e=parseInt(d.value),t=parseInt(u.value);isNaN(e)||isNaN(t)?alert(translations.invalid_dimensions):i.setCropBoxData({width:e,height:t})}),document.getElementById("crop-confirm").addEventListener("click",function(){i.getCroppedCanvas().toBlob(function(e){var t=new FormData;t.append("relativeFilePath",c.dataset.relativePath),t.append("x",i.getData().x),t.append("y",i.getData().y),t.append("width",i.getData().width),t.append("height",i.getData().height),t.append("subFolder","{{ currentFolder }}"),fetch(krbeFilemanagerUrlFctCrop,{method:"POST",body:t}).then(e=>e.json()).then(e=>{e.relativeFilePath?(alert(translations.image_cropped_successfully),n(document.getElementById("files-list").getAttribute("krbe-filemanager-currentfolder")),s.style.display="none",i&&i.destroy()):alert(translations.error_during_cropping)})})}),document.getElementById("crop-cancel").addEventListener("click",function(){s.style.display="none",i&&i.destroy()}),document.getElementById("move-modal")),f=(document.querySelectorAll(".move-select").forEach(function(e){e.addEventListener("click",function(e){e.preventDefault(),document.querySelectorAll(".move-directory-tree li").forEach(e=>e.classList.remove("selected")),this.parentElement.classList.add("selected")})}),document.getElementById("move-confirm").addEventListener("click",function(){console.log("move confirm");var e=document.querySelector(".move-directory-tree li.selected");e?(e=e.getAttribute("data-path"),fetch(krbeFilemanagerUrlFctMove,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({relativePath:f,destinationSubFolder:e})}).then(e=>e.json()).then(e=>{e.newFilePath?(alert(translations.move_successful),n(document.getElementById("files-list").getAttribute("krbe-filemanager-currentfolder")),m.style.display="none"):alert(translations.error_during_move+(e.error||""))}).catch(e=>{console.error("Erreur:",e),alert(translations.error_during_move)})):alert(translations.select_destination_folder)}),document.getElementById("move-cancel").addEventListener("click",function(){m.style.display="none"}),""),g,p,h=(document.getElementById("files-list").addEventListener("click",function(e){var t,e=e.target.closest("button");e&&(t=e.closest("article"),f=t.getAttribute("data-file"),g=t.getAttribute("data-public"),p=t.getAttribute("data-name"),e.classList.contains("select-btn")?(console.log("Selectionner cliqué pour :",f),window.fileManagerSelectCallback&&window.fileManagerSelectCallback(f)):e.classList.contains("rename-btn")?(console.log("Renommer cliqué pour :",f),(t=prompt(translations.enter_new_name,p))&&t!==p&&fetch(krbeFilemanagerUrlFctRename,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({relativePath:f,newName:t})}).then(e=>e.json()).then(e=>{e.newPath?(alert(translations.renamed_successfully),n(document.getElementById("files-list").getAttribute("krbe-filemanager-currentfolder"))):alert(translations.error_during_renaming+(e.error||""))}).catch(e=>{console.error("Erreur :",e),alert(translations.error_during_renaming)})):e.classList.contains("delete-btn")?(console.log("Supprimer cliqué pour :",f),confirm(translations.confirm_delete)&&fetch(krbeFilemanagerUrlFctDelete,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({relativePath:f})}).then(e=>e.json()).then(e=>{e.success?(alert(translations.deleted_successfully),n(document.getElementById("files-list").getAttribute("krbe-filemanager-currentfolder"))):alert(translations.error_during_deletion)}).catch(e=>{console.error("Erreur :",e),alert(translations.error_during_deletion)})):e.classList.contains("move-btn")?(console.log("Déplacer cliqué pour :",f),m.style.display="flex",document.querySelectorAll(".move-directory-tree li").forEach(e=>{e.classList.remove("selected")})):e.classList.contains("crop-btn")&&(console.log("Crop cliqué pour :",f),c.src=g,c.dataset.relativePath=f,s.style.display="flex",t=(i=new Cropper(c,{aspectRatio:NaN})).getCropBoxData(),d.value=Math.round(t.width),u.value=Math.round(t.height)))}),document.addEventListener("click",function(e){var t;e.target&&e.target.classList.contains("select-btn")&&(e=e.target.closest(".file-item"))&&(t=e.dataset.file,e=e.dataset.public,window.parent.postMessage({type:"filemanager:select",filePath:t,publicPath:e},"*"))}),document.getElementById("files-list").addEventListener("dblclick",function(e){var t,e=e.target.closest(".file-item");e&&(t=e.dataset.file,e=e.dataset.public,window.parent.postMessage({type:"filemanager:select",filePath:t,publicPath:e},"*"))}),0),v=null;document.addEventListener("touchend",function(e){var t=(new Date).getTime(),n=t-h,r=e.target.closest(".file-item");v=n<500&&0<n&&r===v?(e.preventDefault(),n=r.dataset.file,e=r.dataset.public,window.parent.postMessage({type:"filemanager:select",filePath:n,publicPath:e},"*"),h=0,null):(h=t,r)}),document.addEventListener("touchend",function(e){var t;e.target&&e.target.classList.contains("select-btn")&&(e.preventDefault(),e=e.target.closest(".file-item"))&&(t=e.dataset.file,e=e.dataset.public,window.parent.postMessage({type:"filemanager:select",filePath:t,publicPath:e},"*"))})});
//# sourceMappingURL=krbe-filemanager.min.js.map
